#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

# This script runs all CI checks in order from simplest to most complex. Exits
# on the first failure.  Exit on first failure

echo "=== Running CI validation suite ==="
echo

# Function to run a script and handle errors
run_check() {
    local script="$1"
    local name="$2"

    echo ">>> Running $name..."
    if ! "$script"; then
        echo "FAILED: $name failed!"
        exit 1
    fi
    echo "PASSED: $name passed!"
    echo
}

# Get the directory where this script is located
CI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Run checks in order from simplest to most complex
run_check "$CI_DIR/shellcheck" "shellcheck"
run_check "$CI_DIR/fmt" "cargo fmt"
run_check "$CI_DIR/check" "cargo check"
run_check "$CI_DIR/custom_lints" "project-specific lints"
run_check "$CI_DIR/clippy" "cargo clippy"
run_check "$CI_DIR/deny" "cargo deny"
run_check "$CI_DIR/config-validation" "example config validation"
run_check "$CI_DIR/test" "cargo nextest"

# NOTE: These we run only in CI, leaving this note here to allow for as-needed
# local validation.

# run_check "$CI_DIR/integration-test" "integration tests"
# run_check "$CI_DIR/fingerprint" "payload fingerprint verification"

# Optional checks (don't fail if tools aren't available)
echo ">>> Running optional checks..."

# Loom tests
echo ">>> Running loom tests for each crate..."
# shellcheck disable=SC2043
for crate in lading-signal; do
    echo ">>> Running loom tests for $crate..."
    if ! "$CI_DIR/loom" "$crate"; then
        echo "FAILED: loom tests for $crate failed!"
        exit 1
    fi
    echo "PASSED: loom tests for $crate passed!"
    echo
done

# Kani proofs (optional)
if command -v cargo-kani &> /dev/null; then
    echo ">>> Running kani proofs for each crate..."
    # shellcheck disable=SC2043
    for crate in lading_throttle; do
        echo ">>> Running kani proofs for $crate..."
        if ! "$CI_DIR/kani" "$crate"; then
            echo "FAILED: kani proofs for $crate failed!"
            exit 1
        fi
        echo "PASSED: kani proofs for $crate passed!"
        echo
    done
else
    echo "WARNING: Skipping kani proofs (kani not installed)"
fi

# Buf checks (optional)
if command -v buf &> /dev/null; then
    run_check "$CI_DIR/buf" "buf checks"
else
    echo "WARNING: Skipping buf checks (buf not installed)"
fi

echo
echo "=== SUCCESS: All CI checks passed! ==="
