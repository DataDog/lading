#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail

# Fingerprint Verification for Payload Determinism
#
# This script verifies that payload generators produce deterministic output.
# Each payload type has a "golden" fingerprint containing:
#   - A SHA256 hash of the generated output
#   - The Shannon entropy of the output
#
# POLICY:
#   1. UNINTENDED fingerprint changes are not acceptable. If a change causes
#      fingerprints to differ unexpectedly, the change must be investigated.
#
#   2. UNINTENDED entropy changes are not acceptable. If a change causes
#      fingerprints to differ unexpectedly, the change must be investigated.
#
#   3. INTENTIONAL fingerprint changes are acceptable when:
#      - The change deliberately alters RNG usage or payload structure
#      - Entropy is knowingly altered and can be socially agreed to
#      - The new fingerprint is committed alongside the code change
#
# To update a fingerprint after an intentional change:
#   cargo run --release --bin payloadtool -- ci/fingerprints/<type>/lading.yaml --fingerprint > ci/fingerprints/<type>/fingerprint.txt

echo "=== Running fingerprint verification ==="
echo

CI_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

failed=0
total=0
passed=0
entropy_decreased=0

echo "Building payloadtool..."
cargo build --release --bin payloadtool --quiet 2>/dev/null || cargo build --release --bin payloadtool

echo
echo "Checking fingerprints..."
echo

# Extract entropy value from a fingerprint line
# Format: "name: hash entropy=X.XXXX"
extract_entropy() {
    echo "$1" | grep -oE 'entropy=[0-9]+\.[0-9]+' | cut -d= -f2
}

for dir in "$CI_DIR"/fingerprints/*/; do
    if [ ! -d "$dir" ]; then
        continue
    fi

    payload_type=$(basename "$dir")
    config_file="$dir/lading.yaml"
    fingerprint_file="$dir/fingerprint.txt"

    if [ ! -f "$config_file" ]; then
        echo "WARNING: No config found for $payload_type"
        continue
    fi

    total=$((total + 1))

    echo -n "Checking $payload_type... "

    if ! actual=$(cargo run --release --bin payloadtool --quiet -- "$config_file" --fingerprint 2>/dev/null); then
        echo "FAILED (could not generate fingerprint)"
        failed=$((failed + 1))
        continue
    fi

    # Check if golden fingerprint exists
    if [ ! -f "$fingerprint_file" ]; then
        echo "WARNING: No golden fingerprint found"
        echo "  Generated fingerprint:"
        echo "$actual" | while IFS= read -r line; do echo "    $line"; done
        echo "  To save as golden, run:"
        echo "    cargo run --release --bin payloadtool -- $config_file --fingerprint > $fingerprint_file"
        failed=$((failed + 1))
        continue
    fi

    expected=$(cat "$fingerprint_file")
    if [ "$actual" = "$expected" ]; then
        echo "PASSED"
        passed=$((passed + 1))
    else
        # Check if entropy decreased (never acceptable)
        expected_entropy=$(extract_entropy "$expected")
        actual_entropy=$(extract_entropy "$actual")

        if [ -n "$expected_entropy" ] && [ -n "$actual_entropy" ]; then
            # Use awk for floating point comparison
            entropy_decreased_check=$(awk -v a="$actual_entropy" -v e="$expected_entropy" 'BEGIN { print (a < e) ? "yes" : "no" }')
            if [ "$entropy_decreased_check" = "yes" ]; then
                echo "FAILED (ENTROPY DECREASED - never acceptable)"
                echo "  Expected entropy: $expected_entropy"
                echo "  Actual entropy:   $actual_entropy"
                echo "  Entropy decrease indicates less randomness in payload."
                echo "  This change MUST be reverted."
                entropy_decreased=$((entropy_decreased + 1))
                failed=$((failed + 1))
                continue
            fi
        fi

        echo "CHANGED"
        echo "  Expected:"
        echo "$expected" | while IFS= read -r line; do echo "    $line"; done
        echo "  Actual:"
        echo "$actual" | while IFS= read -r line; do echo "    $line"; done
        echo
        echo "  If this change is INTENTIONAL, update the fingerprint:"
        echo "    cargo run --release --bin payloadtool -- $config_file --fingerprint > $fingerprint_file"
        echo
        echo "  If this change is UNINTENDED, investigate and fix the cause."
        failed=$((failed + 1))
    fi
done

echo
echo "=== Summary ==="
echo "Total: $total"
echo "Passed: $passed"
echo "Changed: $((failed - entropy_decreased))"
if [ $entropy_decreased -gt 0 ]; then
    echo "Entropy decreased: $entropy_decreased (MUST REVERT)"
fi

if [ $entropy_decreased -gt 0 ]; then
    echo
    echo "CRITICAL: Entropy decreased in $entropy_decreased payload(s)."
    echo "Changes that reduce entropy are NEVER acceptable and must be reverted."
    exit 1
elif [ $failed -gt 0 ]; then
    echo
    echo "Fingerprint verification found changes."
    echo "If intentional, update the fingerprint files as shown above."
    exit 1
else
    echo
    echo "All fingerprints verified successfully!"
fi
