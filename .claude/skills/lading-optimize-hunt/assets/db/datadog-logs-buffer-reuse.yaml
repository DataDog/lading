id: datadog-logs-buffer-reuse
target: lading_payload/src/datadog_logs.rs::DatadogLog::to_bytes
technique: buffer-reuse
date: 2026-01-21
status: success
verdict: approved
votes:
  duplicate_hunter: approve
  skeptic: approve
  conservative: approve
  rust_expert: approve
  greybeard: approve
measurements:
  benchmarks:
    micro:
      datadog_logs_100MiB_time: +5.41%
      datadog_logs_1000MiB_time: +8.39%
      datadog_logs_100MiB_throughput: +5.72%
      datadog_logs_1000MiB_throughput: +9.16%
    macro:
      time: -2.51%
      memory: -26.07%
      allocations: -8.22%
lessons: |
  The to_bytes method was performing binary search to find the right number of
  members to serialize within max_bytes. Each iteration called serde_json::to_string()
  which allocated a new String. Replaced with a reusable Vec<u8> buffer cleared
  between iterations using serde_json::to_writer().

  Significant memory reduction (26% less total allocated) shows the repeated
  allocations were a major overhead. The optimization is most effective for
  larger payloads where the binary search executes more iterations.

  Pattern: Any binary search or loop that repeatedly serializes to String can
  benefit from buffer reuse.
